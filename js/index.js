var songList,controlManager,root=window.player,$scope=$(document.body),audio=new root.audioControl;function bindEvent(){$(window).on("beforeunload",function(){localStorage.setItem("playerStatus",JSON.stringify({index:controlManager.index,curTime:audio.audio.currentTime,isLoop:audio.isLoop,volume:audio.getVolume()}))}),$(audio.audio).on("ended",function(){if(audio.isLoop)root.process.update(0),audio.play(),root.process.start(!0);else if("play"==audio.status){var o=controlManager.next();$scope.trigger("play:change",o)}}),$(audio.audio).on("waiting",function(){"play"==audio.status&&root.process.stop()}),$(audio.audio).on("canplay",function(){"play"==audio.status&&root.process.start()}),$scope.on("play:change",function(o,t,a){if(audio.setAudio(songList[t].audio),root.render(songList[t]),root.process.renderAllTime(songList[t].duration),"storage"==a){var n=JSON.parse(localStorage.playerStatus);audio.playTo(n.curTime),audio.setVolume(n.volume);var e=n.curTime/songList[t].duration;root.process.update(e),root.process.changePer(e),$scope.find(".vol-show p span").text(Math.floor(100*n.volume)),n.isLoop?(audio.isLoop=!0,$scope.find(".loop-btn").addClass("looping")):(audio.isLoop=!1,$scope.find(".loop-btn").removeClass("looping"))}else root.process.update(0);root.playList.signSong(t),"play"!=audio.status&&"list"!=a||(audio.play(),root.process.start(),$scope.css("animationPlayState","running"))}),$scope.on("tap",".prev-btn",function(){var o=controlManager.prev();$scope.trigger("play:change",o)}),$scope.on("tap",".next-btn",function(){var o=controlManager.next();$scope.trigger("play:change",o)}),$scope.on("tap",".play-btn",function(){"play"==audio.status?(audio.pause(),root.process.stop(),$scope.css("animationPlayState","paused")):"pause"==audio.status&&(audio.play(),root.process.start(),$scope.css("animationPlayState","running")),$(this).toggleClass("playing")}),$scope.on("tap",".list-btn",function(){root.playList.show(controlManager)}),$scope.on("tap",".loop-btn",function(){audio.isLoop?(audio.noLoop(),$(this).removeClass("looping")):(audio.loop(),$(this).addClass("looping"))})}function bindTouch(){var o=$scope.find(".slider-pointer"),t=$scope.find(".pro-wrapper"),a=$scope.find(".vol-control"),n=t.offset(),e=n.left,s=n.width,r=a.offset().height;function i(o){var t=(o.changedTouches[0].clientX-e)/s;return t<0?t=0:1<t&&(t=1),t}t.on("touchstart",function(o){var t=i(o);root.process.update(t);var a=t*songList[controlManager.index].duration;audio.playTo(a),root.process.changePer(t),"play"==audio.status&&root.process.start()}),o.on("touchstart",function(o){o.stopPropagation(),root.process.stop()}).on("touchmove",function(o){var t=i(o);root.process.update(t)}).on("touchend",function(o){var t=i(o),a=t*songList[controlManager.index].duration;audio.playTo(a),root.process.changePer(t),"play"==audio.status&&root.process.start()}),a.on("touchstart",function(o){var e=o.changedTouches[0].clientY;a.on("touchmove",function(o){$scope.find(".vol-show").addClass("show");var t=o.changedTouches[0].clientY,a=(t-e)/r,n=audio.getVolume()-a;n<0?n=0:1<n-a&&(n=1),audio.setVolume(n),$scope.find(".vol-show p span").text(Math.floor(100*n)),e=t}),a.on("touchend",function(){$scope.find(".vol-show").removeClass("show"),a.off("touchmove"),a.off("touchend")})})}function getData(o){$.ajax({type:"get",url:o,success:function(o){if(songList=o,bindEvent(),bindTouch(),root.playList.renderList(o),localStorage.playerStatus){var t=JSON.parse(localStorage.playerStatus).index;controlManager=new root.controlManager(o.length,t),$scope.trigger("play:change",[t,"storage"])}else controlManager=new root.controlManager(o.length,0),$scope.trigger("play:change",0)},error:function(){}})}getData("../mock/data.json");